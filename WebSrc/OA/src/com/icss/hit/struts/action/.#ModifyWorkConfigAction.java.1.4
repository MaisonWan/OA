/*
 * Generated by MyEclipse Struts
 * Template path: templates/java/JavaClass.vtl
 */
package com.icss.hit.struts.action;

import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.List;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import org.apache.struts.action.Action;
import org.apache.struts.action.ActionErrors;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;
import org.apache.struts.action.ActionMessage;

import com.icss.hit.bean.WorkPlanBean;
import com.icss.hit.bean.interfaces.WorkPlanDao;
import com.icss.hit.hibernate.vo.Schedule;
import com.icss.hit.struts.form.ModifyWorkConfigForm;

/** 
 * MyEclipse Struts
 * Creation date: 08-05-2009
 * 
 * XDoclet definition:
 * @struts.action path="/modifyWorkConfig" name="modifyWorkConfigForm" input="/work/modifyWorkConfig.jsp" scope="request" validate="true"
 */
public class ModifyWorkConfigAction extends Action {
	/*
	 * Generated Methods
	 */

	/** 
	 * Method execute
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 */
	public ActionForward execute(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		ModifyWorkConfigForm modifyWorkConfigForm = (ModifyWorkConfigForm) form;
		
		long userId=1;
		
		if( request.getSession().getAttribute("UserId") != null ){
			userId = Long.parseLong(request.getSession().getAttribute("UserId").toString());
		}else{
			return mapping.findForward("NullLogin");
		}
		WorkPlanDao wp = new WorkPlanBean();
		Schedule sch = wp.getScheduleInfo(Long.parseLong(modifyWorkConfigForm.getSch_id()));
			
			//判断时间是否为空
			String beginTime=modifyWorkConfigForm.getSch_begintime();
			String endTime=modifyWorkConfigForm.getSch_endtime();
			boolean flag=true;
			if(modifyWorkConfigForm.getSch_begintime()!=null&&modifyWorkConfigForm.getSch_endtime()!=null&&modifyWorkConfigForm.getSch_begintime().length()>0&&modifyWorkConfigForm.getSch_endtime().length()>0&&modifyWorkConfigForm.getSch_content()!=null&&modifyWorkConfigForm.getSch_content().length()>0&&modifyWorkConfigForm.getSch_title()!=null&&modifyWorkConfigForm.getSch_title().length()>0)
			{
				SimpleDateFormat bartDateFormat =new SimpleDateFormat("yyyy-MM-dd kk:mm:ss");
				try {
					
					//判断时间是否冲突
					
						List<Schedule> slist = wp.getSchedule(userId);
						try {
							for (int i = 0; i < slist.size(); i++) 
							{
								Schedule schedule = slist.get(i);
								//申请的开始时间要晚于已经安排的日程结束的时间
								long m =bartDateFormat.parse(beginTime).getTime()-schedule.getSchEndtime().getTime();
								//申请的结束时间要早于已经安排的日程开始的时间
								long n = bartDateFormat.parse(endTime).getTime()-schedule.getSchBegintime().getTime();
								if (m>0||n<0)
								{
									continue;
								} 
								else
								{
									flag=false;
									break;
								}
							}
						sch.setSchContent(modifyWorkConfigForm.getSch_content());
						sch.setSchTitle(modifyWorkConfigForm.getSch_title());
						
						if (flag)
						{
							sch.setSchBegintime(bartDateFormat.parse(beginTime));
							sch.setSchEndtime(bartDateFormat.parse(endTime));
							if (wp.saveSchedule(sch))
							{
								return mapping.findForward("ModifyWorkConfig.succeed");
							}
							else 
							{
								return mapping.findForward("ModifyWorkConfig.faild");
					
							}
							
						}
						else
						{
							ActionErrors errors = new ActionErrors();
							errors.add("sch_begintime", new ActionMessage("WorkAdd.Timeconflict"));
			 				saveErrors(request, errors);
//							request.setAttribute("form", modifyWorkConfigForm);
							return mapping.findForward("ModifyWorkConfig.faild");
						}
					} 
					catch (RuntimeException e)
					{
						// TODO Auto-generated catch block
						e.printStackTrace();
					}

				}
				catch (ParseException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
					
				}
				
			}
			
		return mapping.findForward("ModifyWorkConfig.faild");
		
		
	}
}